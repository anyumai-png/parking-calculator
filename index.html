<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>æ³Šè»Šæ”¶è²»è¨ˆç®—å™¨</title>
  <style>
    :root{
      --bg:#0b1220; --card:#0f172a; --text:#e5e7eb; --muted:#a9b2bd; --border:#1f2937;
      --blue:#3b82f6; --green:#22c55e; --yellow:#fde047; --red:#ef4444;
      --tabInactive:#0b1220; --tabActive:#0f213f; --input-bg:#0b1220; --chip:#0b1a33;
      --focus:#a78bfa;
    }
    .theme-light{
      --bg:#ffffff; --card:#ffffff; --text:#111827; --muted:#334155; --border:#0f172a33;
      --tabInactive:#e5e7eb; --tabActive:#ffffff; --input-bg:#ffffff; --chip:#eef2ff;
      --blue:#1d4ed8; --green:#15803d; --yellow:#b45309; --red:#b91c1c; --focus:#7c3aed;
    }
    *{box-sizing:border-box}
    html,body{height:100%;}
    body{margin:0; font-family:"Noto Sans TC","Microsoft JhengHei",system-ui,Segoe UI,Roboto,Arial,sans-serif;
      background:var(--bg); color:var(--text); -webkit-text-size-adjust:100%; line-height:1.35;}
    .app{min-height:100%; display:flex; flex-direction:column}
    header{position:sticky; top:0; z-index:20; background:linear-gradient(180deg,rgba(12,20,38,.95),rgba(11,18,32,.95));
      border-bottom:1px solid var(--border); padding:12px env(safe-area-inset-right) 8px env(safe-area-inset-left); backdrop-filter: blur(6px)}
    .theme-light header{ background:linear-gradient(180deg,#f8fafc,#f1f5f9); }
    .head-row{display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap}
    .title{font-size:20px; font-weight:900; color:#93c5fd; letter-spacing:0.5px}
    .theme-light .title{ color:#1d4ed8 }
    .clock{font-variant-numeric:tabular-nums; font-size:22px; font-weight:900; color:#bfdbfe; background:#0b1a33;
      border:1px solid var(--border); border-radius:10px; padding:8px 12px; white-space:nowrap}
    .theme-light .clock{ color:#0f172a; background:#e5e7eb; border-color:#cbd5e1 }
    .tabs{margin-top:10px; display:flex; gap:10px; overflow:auto; -webkit-overflow-scrolling:touch; padding-bottom:6px}
    .tabbtn{flex:0 0 auto; padding:14px 36px; font-size:18px; font-weight:900; color:#cbd5e1; border:1px solid var(--border);
      border-bottom:none; background:var(--tabInactive); border-top-left-radius:14px; border-top-right-radius:14px; user-select:none; cursor:pointer;
      box-shadow: inset 0 -2px 0 rgba(0,0,0,.15)}
    .tabbtn.active{background:var(--tabActive); color:var(--text); border-color:#21406b; box-shadow: 0 6px 12px rgba(0,0,0,.25)}
    .theme-light .tabbtn{ color:#111827; border-color:#cbd5e1 }
    .theme-light .tabbtn.active{ border-color:#94a3b8; box-shadow: 0 6px 12px rgba(0,0,0,.08) }
    main{flex:1; padding:12px; max-width:900px; width:100%; margin:0 auto}
    .card{background:var(--card); border:1px solid var(--border); border-radius:16px; padding:16px; box-shadow:0 8px 24px rgba(0,0,0,.12)}
    .theme-light .card{ box-shadow:0 6px 18px rgba(0,0,0,.06) }
    .section-title{font-size:17px; color:#22c55e; margin:2px 0 12px 2px}
    .theme-light .section-title{ color:#15803d }
    label{display:block; font-size:16px; margin:8px 0 6px; color:#93c5fd}
    .theme-light label{ color:#1d4ed8 }
    .row{display:flex; gap:12px; flex-wrap:wrap}
    .row .col{flex:1 1 300px; min-width:0}
    @media (max-width: 430px){ .row .col{flex:1 1 100%} }
    input[type="time"], input[type="number"], input[type="text"]{
      width:100%; max-width:100%; font-size:22px; padding:12px 14px; border-radius:12px;
      border:2px solid var(--border); background:var(--input-bg); color:var(--text); outline:none
    }
    input:focus{ box-shadow:0 0 0 3px var(--focus) inset; }
    input[type="number"]::-webkit-outer-spin-button,input[type="number"]::-webkit-inner-spin-button{-webkit-appearance:none;margin:0}
    .btns{display:flex; gap:10px; flex-wrap:wrap; margin-top:8px}
    .btn{flex:1 1 200px; font-size:19px; font-weight:900; padding:16px; border:none; border-radius:14px; cursor:pointer}
    .btn.blue{background:var(--blue); color:#fff}
    .btn.green{background:var(--green); color:#fff}
    .btn.ghost{background:var(--input-bg); color:var(--text); border:2px solid var(--border)}
    .btn.red{background:var(--red); color:#fff}
    .seg{display:flex; gap:8px; flex-wrap:wrap}
    .seg .chipbtn{flex:1 1 150px; padding:10px 12px; border-radius:12px; border:2px solid var(--border);
      background:var(--input-bg); color:var(--text); font-weight:800; font-size:18px; cursor:pointer}
    .seg .chipbtn.active{ background:#0b1a33; color:#dbeafe; border-color:#21406b }
    .theme-light .seg .chipbtn.active{ background:#e5e7eb; color:#111827; border-color:#64748b }
    .result{margin-top:10px; background:var(--input-bg); border:2px dashed var(--border); border-radius:12px; padding:14px; font-size:18px; line-height:1.5}
    .money{font-size:38px; font-weight:900; color:#fde047}
    .theme-light .money{ color:#b45309 }
    .muted{color:var(--muted); font-size:15px}
    .chip{display:inline-block; margin:6px 0 10px; padding:8px 10px; border-radius:10px; background:var(--chip); border:1px solid var(--border); color:#dbeafe; font-size:14px}
    .theme-light .chip{ color:#1e293b }
    table{width:100%; border-collapse:collapse}
    th,td{padding:12px; border-bottom:1px solid var(--border); font-size:16px}
    th{color:#93c5fd; text-align:left}
    .theme-light th{ color:#1d4ed8 }
    td{color:var(--text)} .right{text-align:right}
    .warn{color:#ef4444; font-weight:800; margin-top:6px}
    .filters{display:flex; gap:10px; flex-wrap:wrap; margin:10px 0}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="head-row">
        <div class="title">ğŸš— æ³Šè»Šæ”¶è²»è¨ˆç®—å™¨</div>
        <div class="clock" id="clock">--/--/---- --:--</div>
      </div>
      <nav class="tabs" role="tablist" aria-label="Navigation">
        <button class="tabbtn active" data-tab="home" id="tab-home" onclick="showTab('home')">ä¸»é </button>
        <button class="tabbtn" data-tab="settings" id="tab-settings" onclick="showTab('settings')">è¨­å®š</button>
        <button class="tabbtn" data-tab="history" id="tab-history" onclick="showTab('history')">æ›†å²</button>
      </nav>
    </header>

    <main>
      <!-- Home -->
      <section id="page-home" class="page active">
        <div class="card">
          <p class="section-title">ä¸»é </p>
          <div class="chip" id="presetChip">ä½¿ç”¨é è¨­ï¼šâ€”</div>

          <label>è»Šè¼›é¡å‹</label>
          <div class="seg" role="group" aria-label="vehicle type">
            <button class="chipbtn active" id="veh-private" onclick="setVeh('private')">ç§å®¶è»Š</button>
            <button class="chipbtn" id="veh-truck" onclick="setVeh('truck')">è²¨è»Š</button>
          </div>

          <div class="row">
            <div class="col">
              <label for="start">å…¥è»Šæ™‚é–“ï¼ˆHH:MMï¼‰</label>
              <input id="start" type="time" step="60">
            </div>
            <div class="col">
              <label for="end">å‡ºé–˜æ™‚é–“ï¼ˆHH:MMï¼‰</label>
              <input id="end" type="time" step="60">
            </div>
          </div>

          <label>å•†å ´æ³Šè»Šå„ªæƒ </label>
          <div class="seg" role="group" aria-label="mall promo eligible">
            <button class="chipbtn" id="promo-no" onclick="setPromo(false)">æœªé”æ¨™</button>
            <button class="chipbtn" id="promo-yes" onclick="setPromo(true)">å·²é”æ¨™ï¼ˆå…æ™‚æ•¸å¥—ç”¨ï¼‰</button>
          </div>

          <div id="remarkWrap" style="display:none">
            <label for="remark">å‚™è¨»ï¼ˆé¸å¡«ï¼Œæœƒå­˜å…¥æ›†å²ï¼‰</label>
            <input id="remark" type="text" placeholder="ä¾‹å¦‚ï¼šè»Šç‰Œã€åœè»Šå ´åç¨±â€¦">
          </div>

          <div class="btns">
            <button class="btn blue" id="now" onclick="setNow()">å‡ºé–˜ï¼ç¾åœ¨</button>
            <button class="btn ghost" id="swap" onclick="swapTimes()">å…¥/å‡º å°èª¿</button>
            <button class="btn green" id="calc" onclick="calculate()">è¨ˆç®—æ‡‰æ”¶ï¼ˆä½¿ç”¨é è¨­ï¼‰</button>
            <button class="btn ghost" id="clear" onclick="clearForm()">æ¸…é™¤</button>
          </div>

          <div class="result" aria-live="polite">
            <div>ç¸½æ™‚é•·ï¼š<span id="duration">â€”</span> <span class="muted" id="freeNote"></span></div>
            <div>å…¬å¼ï¼š<span id="formula">â€”</span></div>
            <div class="money" id="amount">$0.00</div>
            <div class="muted" id="stamp">è¨ˆç®—æ™‚é–“ï¼šâ€”</div>
            <div class="warn" id="crossday" style="display:none">âš ï¸ è·¨æ—¥ï¼ˆ+1å¤©ï¼‰</div>
            <div class="muted" id="promoText"></div>
          </div>
        </div>
      </section>

      <!-- Settings -->
      <section id="page-settings" class="page" style="display:none">
        <div class="card">
          <p class="section-title">è¨­å®š</p>

          <label>è¨ˆè²»å–®ä½ï¼ˆåªåœ¨é€™è£¡è¨­å®šï¼‰</label>
          <div class="row">
            <div class="col"><button class="btn ghost" id="unit-hour" onclick="setUnit('hour')">æ¯å°æ™‚è¨ˆ</button></div>
            <div class="col"><button class="btn ghost" id="unit-half" onclick="setUnit('half')">æ¯åŠå°æ™‚è¨ˆ</button></div>
          </div>

          <label>é è¨­æ”¶è²»ï¼ˆ$ / å–®ä½ï¼‰</label>
          <div class="row">
            <div class="col">
              <label for="ratePrivate">ç§å®¶è»Šå–®åƒ¹</label>
              <input id="ratePrivate" type="number" min="0" step="0.5" placeholder="ä¾‹å¦‚ï¼š12">
            </div>
            <div class="col">
              <label for="rateTruck">è²¨è»Šå–®åƒ¹</label>
              <input id="rateTruck" type="number" min="0" step="0.5" placeholder="ä¾‹å¦‚ï¼š15">
            </div>
          </div>

          <div class="row">
            <div class="col">
              <label for="freeMin">å…è²»æ™‚æ®µï¼ˆåˆ†é˜ï¼Œ0 è¡¨ç¤ºæ²’æœ‰ï¼‰</label>
              <input id="freeMin" type="number" min="0" step="1" placeholder="ä¾‹å¦‚ï¼š15">
            </div>
            <div class="col">
              <label for="capFee">å°é ‚é‡‘é¡ï¼ˆ$ï¼Œ0 è¡¨ç¤ºæ²’æœ‰ï¼‰</label>
              <input id="capFee" type="number" min="0" step="0.5" placeholder="ä¾‹å¦‚ï¼š200">
            </div>
          </div>

          <label>å•†å ´æ³Šè»Šå„ªæƒ </label>
          <div class="row">
            <div class="col">
              <label for="promoHours">å…æ™‚æ•¸ï¼ˆå°æ™‚ï¼‰</label>
              <input id="promoHours" type="number" min="0" step="0.5" placeholder="ä¾‹å¦‚ï¼š2">
            </div>
            <div class="col">
              <label for="promoDefault">é è¨­æ˜¯å¦é”æ¨™ï¼ˆä¸»é å¯åˆ‡æ›ï¼‰</label>
              <select id="promoDefault" style="width:100%; font-size:18px; padding:12px 14px; border-radius:12px; border:2px solid var(--border); background:var(--input-bg); color:var(--text)">
                <option value="false">æœªé”æ¨™</option>
                <option value="true">å·²é”æ¨™</option>
              </select>
            </div>
          </div>

          <label>ä¸»é¡Œ</label>
          <div class="row">
            <div class="col"><button class="btn ghost" id="theme-dark" onclick="setTheme('dark')">é»‘è‰²ä¸»é¡Œ</button></div>
            <div class="col"><button class="btn ghost" id="theme-light" onclick="setTheme('light')">æ·ºè‰²ä¸»é¡Œï¼ˆé«˜å°æ¯”ï¼‰</button></div>
          </div>

          <label>å‚™è¨»æ¬„é¡¯ç¤º</label>
          <div class="row">
            <div class="col"><button class="btn ghost" id="remark-on" onclick="setRemarkVisible(true)">é¡¯ç¤ºå‚™è¨»</button></div>
            <div class="col"><button class="btn ghost" id="remark-off" onclick="setRemarkVisible(false)">éš±è—å‚™è¨»ï¼ˆé è¨­ï¼‰</button></div>
          </div>

          <div class="btns">
            <button class="btn green" id="save-def" onclick="saveDefaults()">å„²å­˜é è¨­</button>
            <button class="btn ghost" id="reset-def" onclick="resetDefaults()">æ¸…ç©ºé è¨­</button>
          </div>
          <p class="muted">é è¨­å„²å­˜åœ¨æ­¤è£ç½®ï¼ˆlocalStorageï¼‰ã€‚ä¸»é è¨ˆç®—æœƒä½¿ç”¨é€™äº›é è¨­ã€‚</p>
        </div>
      </section>

      <!-- History -->
      <section id="page-history" class="page" style="display:none">
        <div class="card">
          <p class="section-title">æ›†å²</p>

          <div class="filters">
            <input id="filterText" type="text" placeholder="ç¯©é¸ï¼ˆæœƒæœå°‹æ‰€æœ‰æ¬„ä½ï¼ŒåŒ…æ‹¬å‚™è¨»ï¼‰" style="flex:1 1 320px; font-size:18px; padding:10px 12px">
            <button class="btn ghost" id="applyFilter" onclick="renderHistory()">å¥—ç”¨ç¯©é¸</button>
            <button class="btn ghost" id="clearFilter" onclick="document.getElementById('filterText').value=''; renderHistory()">æ¸…é™¤ç¯©é¸</button>
          </div>

          <div class="btns">
            <button class="btn ghost" id="export" onclick="exportCSV()">åŒ¯å‡º CSV</button>
            <button class="btn red" id="clear-his" onclick="clearHistory()">æ¸…é™¤æ­·å²</button>
          </div>

          <div style="overflow:auto; margin-top:10px">
            <table>
              <thead>
                <tr>
                  <th>æ™‚é–“æˆ³</th><th>å…¥</th><th>å‡º</th><th>è»Šç¨®</th><th>å–®ä½</th>
                  <th class="right">å–®åƒ¹($)</th><th class="right">å…è²»(åˆ†)</th><th class="right">å°é ‚($)</th>
                  <th class="right">æ™‚é•·</th><th class="right">é‡‘é¡($)</th><th>å‚™è¨»</th><th>å„ªæƒ </th>
                </tr>
              </thead>
              <tbody id="hisbody"><tr><td colspan="12" class="muted">æš«ç„¡ç´€éŒ„</td></tr></tbody>
            </table>
          </div>
        </div>
      </section>
    </main>
  </div>

  <script>
    // ===== Helpers =====
    function pad(n){return String(n).padStart(2,'0');}
    function nowParts(){const d=new Date(); return {d, dd:pad(d.getDate()), mm:pad(d.getMonth()+1), yyyy:d.getFullYear(), hh:pad(d.getHours()), nn:pad(d.getMinutes())};}
    function nowHM(){const p=nowParts(); return p.hh+':'+p.nn;}
    function nowStamp(){const p=nowParts(); return p.dd+'/'+p.mm+'/'+p.yyyy+' '+p.hh+':'+p.nn;}
    function toSecHM(hm){const a=hm.split(':').map(Number); return (a[0]*3600)+(a[1]*60);}
    function fromSec(sec){const h=Math.floor(sec/3600),m=Math.floor((sec%3600)/60); return h+'å°æ™‚'+m+'åˆ†é˜';}
    function money(n){return Number(n).toFixed(2);}
    function saveLS(k,v){localStorage.setItem(k,JSON.stringify(v));}
    function loadLS(k,def){try{const v=JSON.parse(localStorage.getItem(k)); return v==null?def:v}catch(_){return def}}

    // ===== App State =====
    var DEFAULTS = loadLS('parking_defaults', {
      unit:'hour',
      ratePrivate:12, rateTruck:15,
      freeMin:0, capFee:0,
      theme:'dark',
      showRemark:false,
      promoHours:2,
      promoDefault:false
    });
    var UI = { veh:'private', promo: DEFAULTS.promoDefault===true };

    // ===== Clock =====
    function tickClock(){ var el=document.getElementById('clock'); if(el) el.textContent = nowStamp(); }
    setInterval(tickClock, 1000);

    // ===== Tabs =====
    function showTab(name){
      var tabs=document.querySelectorAll('.tabbtn');
      ['home','settings','history'].forEach(function(k){
        var page=document.getElementById('page-'+k);
        if(page){ page.style.display = (k===name?'block':'none'); }
      });
      tabs.forEach(function(b){ b.classList.toggle('active', b.dataset.tab===name); });
      if(name==='history'){ renderHistory(); }
      if(name==='home'){ reflectPresetChip(); reflectRemarkVisibility(); reflectVehicleButtons(); reflectPromoButtons(); }
    }

    // ===== Settings logic =====
    function applyTheme(){ document.body.classList.toggle('theme-light', DEFAULTS.theme==='light'); }
    function reflectDefaultsUI(){
      var rp=document.getElementById('ratePrivate');
      var rt=document.getElementById('rateTruck');
      var freeMinInput=document.getElementById('freeMin');
      var capFeeInput=document.getElementById('capFee');
      var uh=document.getElementById('unit-hour'); var uf=document.getElementById('unit-half');
      var tDark=document.getElementById('theme-dark'); var tLight=document.getElementById('theme-light');
      var rOn=document.getElementById('remark-on'); var rOff=document.getElementById('remark-off');
      var pH=document.getElementById('promoHours'); var pD=document.getElementById('promoDefault');
      if(rp) rp.value = DEFAULTS.ratePrivate;
      if(rt) rt.value = DEFAULTS.rateTruck;
      if(freeMinInput) freeMinInput.value = DEFAULTS.freeMin;
      if(capFeeInput) capFeeInput.value = DEFAULTS.capFee;
      if(pH) pH.value = DEFAULTS.promoHours;
      if(pD) pD.value = String(DEFAULTS.promoDefault===true);
      if(uh){ uh.classList.toggle('green', DEFAULTS.unit==='hour'); uh.classList.toggle('ghost', DEFAULTS.unit!=='hour'); }
      if(uf){ uf.classList.toggle('green', DEFAULTS.unit==='half'); uf.classList.toggle('ghost', DEFAULTS.unit!=='half'); }
      if(tDark){ tDark.classList.toggle('green', DEFAULTS.theme==='dark'); tDark.classList.toggle('ghost', DEFAULTS.theme!=='dark'); }
      if(tLight){ tLight.classList.toggle('green', DEFAULTS.theme==='light'); tLight.classList.toggle('ghost', DEFAULTS.theme!=='light'); }
      if(rOn){ rOn.classList.toggle('green', DEFAULTS.showRemark===true); rOn.classList.toggle('ghost', DEFAULTS.showRemark!==true); }
      if(rOff){ rOff.classList.toggle('green', DEFAULTS.showRemark===false); rOff.classList.toggle('ghost', DEFAULTS.showRemark!==false); }
      applyTheme(); reflectPresetChip(); reflectRemarkVisibility(); reflectVehicleButtons(); reflectPromoButtons();
    }
    function setUnit(u){ DEFAULTS.unit=u; reflectDefaultsUI(); }
    function setTheme(t){ DEFAULTS.theme=t; reflectDefaultsUI(); }
    function setRemarkVisible(v){ DEFAULTS.showRemark=!!v; reflectDefaultsUI(); }
    function saveDefaults(){
      var rp=parseFloat(document.getElementById('ratePrivate').value||'12');
      var rt=parseFloat(document.getElementById('rateTruck').value||'15');
      var freeMin=parseInt(document.getElementById('freeMin').value||'0',10)||0;
      var capFee=parseFloat(document.getElementById('capFee').value||'0')||0;
      var promoHours=parseFloat(document.getElementById('promoHours').value||'2')||0;
      var promoDefault=(document.getElementById('promoDefault').value==='true');
      DEFAULTS.ratePrivate=isNaN(rp)?12:rp;
      DEFAULTS.rateTruck=isNaN(rt)?15:rt;
      DEFAULTS.freeMin=isNaN(freeMin)?0:freeMin;
      DEFAULTS.capFee=isNaN(capFee)?0:capFee;
      DEFAULTS.promoHours=isNaN(promoHours)?0:promoHours;
      DEFAULTS.promoDefault=promoDefault;
      saveLS('parking_defaults', DEFAULTS);
      alert('é è¨­å·²å„²å­˜');
      reflectDefaultsUI();
    }
    function resetDefaults(){
      localStorage.removeItem('parking_defaults');
      DEFAULTS={unit:'hour', ratePrivate:12, rateTruck:15, freeMin:0, capFee:0, theme:'dark', showRemark:false, promoHours:2, promoDefault:false};
      alert('å·²æ¸…ç©ºé è¨­ï¼Œæ¢å¾©é è¨­å€¼');
      reflectDefaultsUI();
    }
    function reflectPresetChip(){
      var unitName = DEFAULTS.unit==='hour' ? 'æ¯å°æ™‚' : 'æ¯åŠå°æ™‚';
      var free = DEFAULTS.freeMin ? 'ï½œå…è²»å‰ '+DEFAULTS.freeMin+' åˆ†é˜' : '';
      var cap = (DEFAULTS.capFee && DEFAULTS.capFee>0) ? 'ï½œå°é ‚ $'+money(DEFAULTS.capFee) : '';
      var chip=document.getElementById('presetChip'); if(chip){ chip.textContent = 'ä½¿ç”¨é è¨­ï¼š'+unitName+free+cap+'ï½œç§å®¶è»Š $'+money(DEFAULTS.ratePrivate)+'ï½œè²¨è»Š $'+money(DEFAULTS.rateTruck); }
    }
    function reflectRemarkVisibility(){
      var wrap=document.getElementById('remarkWrap');
      if(wrap){ wrap.style.display = (DEFAULTS.showRemark? 'block':'none'); }
    }
    function reflectVehicleButtons(){
      var p=document.getElementById('veh-private'); var t=document.getElementById('veh-truck');
      if(p) p.classList.toggle('active', UI.veh==='private');
      if(t) t.classList.toggle('active', UI.veh==='truck');
    }
    function reflectPromoButtons(){
      var no=document.getElementById('promo-no'); var yes=document.getElementById('promo-yes');
      if(no) no.classList.toggle('active', UI.promo===false);
      if(yes) yes.classList.toggle('active', UI.promo===true);
    }
    function setVeh(v){ UI.veh=v; reflectVehicleButtons(); }
    function setPromo(v){ UI.promo=!!v; reflectPromoButtons(); }

    // ===== Home actions =====
    function initTimes(){ var s=document.getElementById('start'), e=document.getElementById('end'); if(s) s.value=nowHM(); if(e) e.value=nowHM(); }
    function setNow(){ var e=document.getElementById('end'); if(e) e.value=nowHM(); }
    function swapTimes(){ var s=document.getElementById('start'), e=document.getElementById('end'); if(s&&e){ var a=s.value, b=e.value; if(a&&b){ s.value=b; e.value=a; }}}
    function clearForm(){
      initTimes();
      var remark=document.getElementById('remark'); if(remark) remark.value='';
      var duration=document.getElementById('duration'); if(duration) duration.textContent='â€”';
      var freeNote=document.getElementById('freeNote'); if(freeNote) freeNote.textContent='';
      var formula=document.getElementById('formula'); if(formula) formula.textContent='â€”';
      var amount=document.getElementById('amount'); if(amount) amount.textContent='$0.00';
      var stamp=document.getElementById('stamp'); if(stamp) stamp.textContent='è¨ˆç®—æ™‚é–“ï¼šâ€”';
      var cross=document.getElementById('crossday'); if(cross) cross.style.display='none';
      var promoText=document.getElementById('promoText'); if(promoText) promoText.textContent='';
    }

    // ===== History & CSV =====
    function matchesFilter(text,kw){ if(!kw) return true; return (text||'').toString().toLowerCase().includes(kw.toLowerCase()); }
    function renderHistory(){
      var hisBody=document.getElementById('hisbody'); if(!hisBody) return;
      var kw=(document.getElementById('filterText').value||'').trim();
      var his=loadLS('parking_history', []);
      hisBody.innerHTML='';
      var filtered=his.filter(function(r){ return Object.values(r).some(function(v){return matchesFilter(v,kw);}); });
      if(filtered.length===0){ hisBody.innerHTML='<tr><td colspan="12" class="muted">æ²’æœ‰ç¬¦åˆçš„ç´€éŒ„</td></tr>'; return; }
      filtered.forEach(function(r){
        var tr=document.createElement('tr');
        tr.innerHTML='<td>'+r.ts+'</td><td>'+r.start+'</td><td>'+r.end+'</td><td>'+r.veh+'</td><td>'+r.unit+'</td>'+
                     '<td class="right">'+money(r.rate)+'</td><td class="right">'+(r.freeMin||0)+'</td>'+
                     '<td class="right">'+money(r.capFee||0)+'</td><td class="right">'+r.dur+'</td>'+
                     '<td class="right">'+money(r.amt)+'</td><td>'+(r.remark||'')+'</td><td>'+(r.promoLabel||'')+'</td>';
        hisBody.appendChild(tr);
      });
    }
    function exportCSV(){
      var his=loadLS('parking_history', []);
      if(his.length===0){ alert('æ²’æœ‰æ­·å²å¯åŒ¯å‡º'); return; }
      var header=['æ™‚é–“æˆ³','å…¥','å‡º','è»Šç¨®','å–®ä½','å–®åƒ¹($)','å…è²»(åˆ†)','å°é ‚($)','æ™‚é•·','é‡‘é¡($)','å‚™è¨»','å„ªæƒ '];
      var lines=[header.join(',')];
      his.forEach(function(r){
        var row=[r.ts,r.start,r.end,r.veh,r.unit,money(r.rate),r.freeMin||0,money(r.capFee||0),r.dur,money(r.amt),(r.remark||''),(r.promoLabel||'')]
          .map(function(x){return '"'+String(x).replace(/"/g,'""')+'"';}).join(',');
        lines.push(row);
      });
      var blob=new Blob([lines.join('\n')],{type:'text/csv;charset=utf-8;'});
      var url=URL.createObjectURL(blob);
      var a=document.createElement('a'); a.href=url; a.download='parking_history.csv'; a.click(); URL.revokeObjectURL(url);
    }
    function clearHistory(){
      if(confirm('ç¢ºå®šæ¸…é™¤æ‰€æœ‰æ­·å²ï¼Ÿæ­¤å‹•ä½œä¸èƒ½é‚„åŸã€‚')){
        localStorage.removeItem('parking_history'); renderHistory();
      }
    }

    // ===== Calculation =====
    function calculate(){
      var s=(document.getElementById('start').value||''); var e=(document.getElementById('end').value||'');
      var unitIsHour = (DEFAULTS.unit==='hour');
      var rate = (UI.veh==='truck') ? parseFloat(DEFAULTS.rateTruck||'15') : parseFloat(DEFAULTS.ratePrivate||'12');
      var freeM=parseInt(DEFAULTS.freeMin||'0',10)||0;
      var cap=parseFloat(DEFAULTS.capFee||'0')||0;
      var promoH = parseFloat(DEFAULTS.promoHours||'0')||0;
      if(!s||!e||isNaN(rate)){ alert('è«‹è¼¸å…¥å®Œæ•´æ™‚é–“ï¼Œä¸¦å…ˆåˆ°ã€Œè¨­å®šã€å„²å­˜é è¨­ã€‚'); return; }

      var secs=toSecHM(e)-toSecHM(s); var crossed=false;
      if(secs<0){ crossed=true; secs += 24*3600; }
      document.getElementById('crossday').style.display = crossed ? 'block':'none';

      var freeSecs=Math.max(0, freeM*60);
      var promoSecs = (UI.promo && promoH>0) ? promoH*3600 : 0;

      var billSecs = Math.max(0, secs - freeSecs - promoSecs);
      var unitSecs = unitIsHour ? 3600 : 1800;
      var unitName = unitIsHour ? 'å°æ™‚' : 'åŠå°æ™‚';
      var units = Math.ceil(billSecs / unitSecs);
      var total = units * rate;
      var hitCap = (cap>0 && total>cap);
      if(hitCap) total = cap;

      document.getElementById('duration').textContent = fromSec(secs);
      document.getElementById('freeNote').textContent = freeSecs>0 ? 'ï¼ˆå·²æ‰£é™¤å…è²» '+freeM+' åˆ†é˜ï¼‰' : '';
      var base = 'æ‡‰è¨ˆæ™‚é•· '+Math.ceil(billSecs/60)+' åˆ†é˜ â†’ ä»¥ '+unitName+' è¨ˆï¼š'+units+' å–®ä½ Ã— $'+money(rate)+' = $'+money(units*rate);
      var capNote = hitCap ? (' â†’ å¥—ç”¨å°é ‚ $'+money(cap)+' â†’ $'+money(total)) : '';
      document.getElementById('formula').textContent = base + capNote;
      document.getElementById('amount').textContent = '$'+money(total);
      document.getElementById('stamp').textContent = 'è¨ˆç®—æ™‚é–“ï¼š'+nowStamp();

      var promoText='';
      if(UI.promo && promoSecs>0){
        promoText='å·²å¥—ç”¨å•†å ´å„ªæƒ ï¼šå… '+promoH+' å°æ™‚ã€‚';
      }else if(promoH>0){
        promoText='å¯è¨­å®šå•†å ´å„ªæƒ ï¼ˆå… '+promoH+' å°æ™‚ï¼‰ï¼Œä¸»é åˆ‡æ›ã€Œå·²é”æ¨™ã€å³å¯å¥—ç”¨ã€‚';
      }
      document.getElementById('promoText').textContent = promoText;

      var remark=(document.getElementById('remark')?document.getElementById('remark').value:'');
      var row={
        ts:nowStamp(), start:s, end:e, veh:(UI.veh==='truck'?'è²¨è»Š':'ç§å®¶è»Š'),
        unit:(unitIsHour?'å°æ™‚':'åŠå°æ™‚'), rate:rate, freeMin:freeM, capFee:cap, dur:fromSec(secs), amt:total,
        remark:remark, promoLabel: (UI.promo?('å·²å¥—ç”¨å… '+promoH+' å°æ™‚'):'æœªå¥—ç”¨')
      };
      var his=loadLS('parking_history', []); his.unshift(row); saveLS('parking_history', his);
    }

    // ===== Bootstrap on window load =====
    function boot(){ tickClock(); initTimes(); reflectDefaultsUI(); }
    window.addEventListener('load', boot);
  </script>
</body>
</html>
